{% extends "base.html" %} {% block title %}Chatbot FILKOM - Chat{% endblock %} {% block styles %}
<style>
  .chat-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 800px;
    height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin: 0 auto;
  }

  .chat-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 20px;
    text-align: center;
    position: relative;
  }

  .status-indicator {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.7;
    }
  }

  .chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8fafc;
  }

  .message {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
  }

  .message.user .message-content {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .message.bot .message-content {
    background: white;
    color: #1f2937;
    border: 1px solid #e5e7eb;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .message-info {
    font-size: 11px;
    color: #6b7280;
    margin-top: 5px;
    text-align: right;
  }

  .message.bot .message-info {
    text-align: left;
  }

  .entity-tags {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  .entity-tag {
    background: rgba(79, 70, 229, 0.1);
    color: #4f46e5;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    border: 1px solid rgba(79, 70, 229, 0.2);
  }

  .quick-suggestions {
    padding: 10px 20px;
    background: #f8fafc;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .suggestion-chip {
    background: white;
    border: 1px solid #d1d5db;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .suggestion-chip:hover {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
  }

  .chat-input-container {
    padding: 20px;
    background: white;
    border-top: 1px solid #e5e7eb;
  }

  .chat-input {
    display: flex;
    gap: 10px;
  }

  .chat-input input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 25px;
    font-size: 14px;
    outline: none;
  }

  .chat-input input:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }

  .send-button {
    padding: 12px 20px;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .send-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  }

  .error-message {
    background: #fef2f2;
    color: #dc2626;
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #fecaca;
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <div class="chat-header">
    <div class="status-indicator"></div>
    <h1>ü§ñ Chatbot FILKOM</h1>
    <p>AI Assistant untuk Fakultas Ilmu Komputer</p>
  </div>

  <div class="chat-messages" id="chatMessages">
    <div class="message bot">
      <div class="message-content">
        <p>Halo! Saya adalah AI Assistant FILKOM. Saya dapat membantu Anda dengan informasi tentang:</p>
        <ul style="margin: 10px 0; padding-left: 20px">
          <li>üìÖ Jadwal perkuliahan dan mata kuliah</li>
          <li>üë®‚Äçüè´ Informasi dosen dan kontak</li>
          <li>üìö Prosedur Akademik (KRS, Cuti Kuliah, Surat Aktif Kuliah, dll.)</li>
          <li>üè¢ Informasi umum FILKOM</li>
        </ul>
        <p>Silakan tanyakan informasi Seputar Akademik di atas!</p>
        <div class="message-info">Bot ‚Ä¢ Sekarang</div>
      </div>
    </div>
  </div>

  <div class="quick-suggestions">
    <div class="suggestion-chip" onclick="sendQuickMessage('Siapa dosen pengampu Machine Learning?')">üë®‚Äçüè´ Dosen ML</div>
    <div class="suggestion-chip" onclick="sendQuickMessage('Jadwal kuliah Basis Data')">üìÖ Jadwal BD</div>
    <div class="suggestion-chip" onclick="sendQuickMessage('Syarat skripsi')">üìù Syarat Skripsi</div>
    <div class="suggestion-chip" onclick="sendQuickMessage('Kontak dosen FILKOM')">üìû Kontak Dosen</div>
  </div>

  <div class="chat-input-container">
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Ketik pertanyaan Anda di sini..." maxlength="500" />
      <button id="sendButton" class="send-button" onclick="sendMessage()">Kirim</button>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let isTyping = false;
  let sessionId = "session_" + Date.now();
  let userId = "user_" + Math.random().toString(36).substr(2, 9);

  const chatMessages = document.getElementById("chatMessages");
  const messageInput = document.getElementById("messageInput");
  const sendButton = document.getElementById("sendButton");

  async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || isTyping) return;

    addMessage(message, "user");
    messageInput.value = "";
    setTyping(true);

    try {
      const response = await fetch("/api/v1/chat/process", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: message, user_id: userId, session_id: sessionId }),
      });

      const data = await response.json();
      if (response.ok) {
        addBotMessage(data);
      } else {
        throw new Error(data.detail || "Server error");
      }
    } catch (error) {
      console.error("Error:", error);
      addMessage("Maaf, terjadi kesalahan dalam memproses pesan Anda. Silakan coba lagi.", "bot", { error: true });
    } finally {
      setTyping(false);
    }
  }

  function sendQuickMessage(message) {
    messageInput.value = message;
    sendMessage();
  }

  function addMessage(content, sender, options = {}) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${sender}`;
    const messageContent = document.createElement("div");
    messageContent.className = "message-content";

    if (options.error) {
      messageContent.innerHTML = `<div class="error-message">${content}</div>`;
    } else {
      messageContent.innerHTML = `<p>${content}</p><div class="message-info">${sender === "user" ? "Anda" : "Bot"} ‚Ä¢ ${getCurrentTime()}</div>`;
    }

    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }

  function addBotMessage(data) {
    const messageDiv = document.createElement("div");
    messageDiv.className = "message bot";
    const messageContent = document.createElement("div");
    messageContent.className = "message-content";

    let content = `<p>${data.response}</p>`;
    if (data.entities && Object.keys(data.entities).length > 0) {
      content += '<div class="entity-tags">';
      for (const [key, value] of Object.entries(data.entities)) {
        content += `<span class="entity-tag">${key}: ${value}</span>`;
      }
      content += "</div>";
    }

    if (data.search_results && data.search_results.length > 0) {
      const topResult = data.search_results[0];
      content += `<div style="margin-top:8px; font-size:11px; color:#6b7280;">
                    üîç <strong>Sumber Terkait:</strong> ${topResult.text || topResult.content}
                </div>`;
    }

    content += `<div class="message-info">
                Bot ‚Ä¢ ${getCurrentTime()} ‚Ä¢ Intent: ${data.intent} (${(data.confidence * 100).toFixed(1)}%)
                ${data.processing_time ? ` ‚Ä¢ ${(data.processing_time * 1000).toFixed(0)}ms` : ""}
            </div>`;

    messageContent.innerHTML = content;
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }

  function setTyping(typing) {
    isTyping = typing;
    sendButton.disabled = typing;
    sendButton.textContent = typing ? "Mengirim..." : "Kirim";
    scrollToBottom();
  }

  function getCurrentTime() {
    return new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
  }

  function scrollToBottom() {
    setTimeout(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
  }
</script>
{% endblock %}
